"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var util = require("./util");
var types_1 = require("./types");
var app = getApp();
function request(method, requestHandler) {
    var url = requestHandler.url, params = requestHandler.params, data = requestHandler.data, headers = requestHandler.headers, mask = requestHandler.mask, loading = requestHandler.loading;
    if (loading === undefined || loading) {
        wx.showLoading && wx.showLoading({ title: 'Loading...', mask: mask ? mask : false });
    }
    var configs = util.getAppParams();
    if (!params) {
        params = {};
    }
    if (!headers) {
        headers = {};
    }
    params.appid = configs.appid;
    params.timestamp = configs.timestamp;
    params.sign = configs.sign;
    var token = wx.getStorageSync(types_1.TOKEN_KEY);
    if (token) {
        headers.Authorization = 'Bearer ' + token;
    }
    return new Promise(function (resolve, reject) {
        wx.request({
            url: util.uriEncode(util.apiEndpoint + url, params),
            data: data,
            method: ['GET', 'POST', 'PATCH', 'PUT', 'DELETE'].indexOf(method) > -1 ? method : 'GET',
            header: Object.assign({
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            }, headers),
            success: function (res) {
                var data = res.data, statusCode = res.statusCode;
                if (statusCode === 200) {
                    resolve(data);
                    return;
                }
                wx.showToast({
                    title: data.message,
                    icon: 'none',
                    duration: 2000
                });
                if (statusCode === 401) {
                    app.globalData.userInfo = undefined;
                    wx.removeStorageSync(types_1.TOKEN_KEY);
                    wx.navigateTo({
                        url: 'page/member/login'
                    });
                }
                reject(res);
            },
            fail: function () {
                reject('Network request failed');
            },
            complete: function () {
                wx.hideLoading && wx.hideLoading();
            }
        });
    });
}
exports.request = request;
function fetch(url, params) {
    if (params === void 0) { params = {}; }
    return request('GET', {
        url: url,
        params: params
    });
}
exports.fetch = fetch;
function post(url, data) {
    if (data === void 0) { data = {}; }
    return request('POST', {
        url: url,
        data: data
    });
}
exports.post = post;
function deleteRequest(url) {
    return request('DELETE', {
        url: url,
    });
}
exports.deleteRequest = deleteRequest;
function put(url, data) {
    if (data === void 0) { data = {}; }
    return request('PUT', {
        url: url,
        data: data
    });
}
exports.put = put;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImh0dHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBK0I7QUFDL0IsaUNBQW9DO0FBR3BDLElBQU0sR0FBRyxHQUFHLE1BQU0sRUFBVSxDQUFDO0FBVzdCLFNBQWdCLE9BQU8sQ0FBSSxNQUFtRixFQUFFLGNBQXdCO0lBQzlILElBQUEsd0JBQUcsRUFBRSw4QkFBTSxFQUFFLDBCQUFJLEVBQUUsZ0NBQU8sRUFBRSwwQkFBSSxFQUFFLGdDQUFPLENBQW9CO0lBQ25FLElBQUksT0FBTyxLQUFLLFNBQVMsSUFBSSxPQUFPLEVBQUU7UUFDcEMsRUFBRSxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBQyxDQUFDLENBQUE7S0FDbkY7SUFDRCxJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDcEMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNULE1BQU0sR0FBRyxFQUFFLENBQUM7S0FDZjtJQUNELElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDVixPQUFPLEdBQUcsRUFBRSxDQUFDO0tBQ2hCO0lBQ0QsTUFBTSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBQzdCLE1BQU0sQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztJQUNyQyxNQUFNLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDM0IsSUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQyxpQkFBUyxDQUFDLENBQUE7SUFDMUMsSUFBSSxLQUFLLEVBQUU7UUFDUCxPQUFPLENBQUMsYUFBYSxHQUFHLFNBQVMsR0FBRyxLQUFLLENBQUM7S0FDN0M7SUFDRCxPQUFPLElBQUksT0FBTyxDQUFJLFVBQUMsT0FBTyxFQUFFLE1BQU07UUFDbEMsRUFBRSxDQUFDLE9BQU8sQ0FBQztZQUNQLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxFQUFFLE1BQU0sQ0FBQztZQUNuRCxJQUFJLEVBQUUsSUFBSTtZQUNWLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSztZQUN2RixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQztnQkFDbEIsY0FBYyxFQUFFLGtCQUFrQjtnQkFDbEMsUUFBUSxFQUFFLGtCQUFrQjthQUMvQixFQUFFLE9BQU8sQ0FBQztZQUNYLE9BQU8sRUFBRSxVQUFVLEdBQUc7Z0JBQ1YsSUFBQSxlQUFJLEVBQUUsMkJBQVUsQ0FBUztnQkFDakMsSUFBSSxVQUFVLEtBQUssR0FBRyxFQUFFO29CQUNwQixPQUFPLENBQUMsSUFBVyxDQUFDLENBQUM7b0JBQ3JCLE9BQU87aUJBQ1Y7Z0JBQ0QsRUFBRSxDQUFDLFNBQVMsQ0FBQztvQkFDVCxLQUFLLEVBQUcsSUFBWSxDQUFDLE9BQU87b0JBQzVCLElBQUksRUFBRSxNQUFNO29CQUNaLFFBQVEsRUFBRSxJQUFJO2lCQUNqQixDQUFDLENBQUM7Z0JBQ0gsSUFBSSxVQUFVLEtBQUssR0FBRyxFQUFFO29CQUNwQixHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxTQUFTLENBQUM7b0JBQ3BDLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBUyxDQUFDLENBQUM7b0JBQ2hDLEVBQUUsQ0FBQyxVQUFVLENBQUM7d0JBQ1YsR0FBRyxFQUFFLG1CQUFtQjtxQkFDM0IsQ0FBQyxDQUFDO2lCQUNOO2dCQUVELE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNmLENBQUM7WUFDRCxJQUFJLEVBQUU7Z0JBQ0YsTUFBTSxDQUFDLHdCQUF3QixDQUFDLENBQUE7WUFDcEMsQ0FBQztZQUNELFFBQVEsRUFBRTtnQkFDTixFQUFFLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtZQUN0QyxDQUFDO1NBQ0osQ0FBQyxDQUFBO0lBQ04sQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBekRELDBCQXlEQztBQVNELFNBQWdCLEtBQUssQ0FBSSxHQUFXLEVBQUUsTUFBVztJQUFYLHVCQUFBLEVBQUEsV0FBVztJQUM3QyxPQUFPLE9BQU8sQ0FBSSxLQUFLLEVBQUU7UUFDckIsR0FBRyxLQUFBO1FBQ0gsTUFBTSxRQUFBO0tBQ1QsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUxELHNCQUtDO0FBUUQsU0FBZ0IsSUFBSSxDQUFJLEdBQVcsRUFBRSxJQUFTO0lBQVQscUJBQUEsRUFBQSxTQUFTO0lBQzFDLE9BQU8sT0FBTyxDQUFJLE1BQU0sRUFBRTtRQUN0QixHQUFHLEtBQUE7UUFDSCxJQUFJLE1BQUE7S0FDUCxDQUFDLENBQUM7QUFDUCxDQUFDO0FBTEQsb0JBS0M7QUFFRCxTQUFnQixhQUFhLENBQUksR0FBVztJQUN4QyxPQUFPLE9BQU8sQ0FBSSxRQUFRLEVBQUU7UUFDeEIsR0FBRyxLQUFBO0tBQ04sQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUpELHNDQUlDO0FBUUQsU0FBZ0IsR0FBRyxDQUFJLEdBQVcsRUFBRSxJQUFTO0lBQVQscUJBQUEsRUFBQSxTQUFTO0lBQ3pDLE9BQU8sT0FBTyxDQUFJLEtBQUssRUFBRTtRQUNyQixHQUFHLEtBQUE7UUFDSCxJQUFJLE1BQUE7S0FDUCxDQUFDLENBQUM7QUFDUCxDQUFDO0FBTEQsa0JBS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuL3V0aWxcIjtcclxuaW1wb3J0IHsgVE9LRU5fS0VZIH0gZnJvbSBcIi4vdHlwZXNcIjtcclxuaW1wb3J0IHsgSU15QXBwIH0gZnJvbSBcIi4uL2FwcFwiO1xyXG5cclxuY29uc3QgYXBwID0gZ2V0QXBwPElNeUFwcD4oKTtcclxuXHJcbmludGVyZmFjZSBJUmVxdWVzdCB7XHJcbiAgICB1cmw6IHN0cmluZztcclxuICAgIHBhcmFtcz86IGFueTsgIC8vIOaLvOaOpeWIsHVybOS4ilxyXG4gICAgZGF0YT86IGFueTsgICAgLy8gcG9zdCDmlbDmja5cclxuICAgIGhlYWRlcnM/OiBhbnk7XHJcbiAgICBtYXNrPzogYm9vbGVhbjtcclxuICAgIGxvYWRpbmc/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVxdWVzdDxUPihtZXRob2Q6ICdPUFRJT05TJ3wgJ0dFVCcgfCAnSEVBRCcgfCAnUE9TVCcgfCAnUFVUJyB8ICdERUxFVEUnIHwgJ1RSQUNFJyB8ICdDT05ORUNUJywgcmVxdWVzdEhhbmRsZXI6IElSZXF1ZXN0KSB7XHJcbiAgICBsZXQgeyB1cmwsIHBhcmFtcywgZGF0YSwgaGVhZGVycywgbWFzaywgbG9hZGluZyB9ID0gcmVxdWVzdEhhbmRsZXI7XHJcbiAgICBpZiAobG9hZGluZyA9PT0gdW5kZWZpbmVkIHx8IGxvYWRpbmcpIHtcclxuICAgICAgd3guc2hvd0xvYWRpbmcgJiYgd3guc2hvd0xvYWRpbmcoe3RpdGxlOiAnTG9hZGluZy4uLicsIG1hc2s6IG1hc2sgPyBtYXNrIDogZmFsc2V9KVxyXG4gICAgfVxyXG4gICAgY29uc3QgY29uZmlncyA9IHV0aWwuZ2V0QXBwUGFyYW1zKCk7XHJcbiAgICBpZiAoIXBhcmFtcykge1xyXG4gICAgICAgIHBhcmFtcyA9IHt9O1xyXG4gICAgfVxyXG4gICAgaWYgKCFoZWFkZXJzKSB7XHJcbiAgICAgICAgaGVhZGVycyA9IHt9O1xyXG4gICAgfVxyXG4gICAgcGFyYW1zLmFwcGlkID0gY29uZmlncy5hcHBpZDtcclxuICAgIHBhcmFtcy50aW1lc3RhbXAgPSBjb25maWdzLnRpbWVzdGFtcDtcclxuICAgIHBhcmFtcy5zaWduID0gY29uZmlncy5zaWduO1xyXG4gICAgY29uc3QgdG9rZW4gPSB3eC5nZXRTdG9yYWdlU3luYyhUT0tFTl9LRVkpXHJcbiAgICBpZiAodG9rZW4pIHtcclxuICAgICAgICBoZWFkZXJzLkF1dGhvcml6YXRpb24gPSAnQmVhcmVyICcgKyB0b2tlbjtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxUPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgIHVybDogdXRpbC51cmlFbmNvZGUodXRpbC5hcGlFbmRwb2ludCArIHVybCwgcGFyYW1zKSxcclxuICAgICAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICAgICAgbWV0aG9kOiBbJ0dFVCcsICdQT1NUJywgJ1BBVENIJywgJ1BVVCcsICdERUxFVEUnXS5pbmRleE9mKG1ldGhvZCkgPiAtMSA/IG1ldGhvZCA6ICdHRVQnLFxyXG4gICAgICAgICAgICBoZWFkZXI6IE9iamVjdC5hc3NpZ24oe1xyXG4gICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgIH0sIGhlYWRlcnMpLFxyXG4gICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IGRhdGEsIHN0YXR1c0NvZGUgfSA9IHJlcztcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0dXNDb2RlID09PSAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEgYXMgYW55KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xyXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiAoZGF0YSBhcyBhbnkpLm1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogJ25vbmUnLFxyXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0dXNDb2RlID09PSA0MDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcHAuZ2xvYmFsRGF0YS51c2VySW5mbyA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgICAgICB3eC5yZW1vdmVTdG9yYWdlU3luYyhUT0tFTl9LRVkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHd4Lm5hdmlnYXRlVG8oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6ICdwYWdlL21lbWJlci9sb2dpbidcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIOWkhOeQhuaVsOaNrlxyXG4gICAgICAgICAgICAgICAgcmVqZWN0KHJlcylcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZmFpbDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KCdOZXR3b3JrIHJlcXVlc3QgZmFpbGVkJylcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nICYmIHd4LmhpZGVMb2FkaW5nKClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9KTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiDlsIHoo4VnZXTmlrnms5VcclxuICogQHBhcmFtIHVybFxyXG4gKiBAcGFyYW0gZGF0YVxyXG4gKiBAcmV0dXJucyB7UHJvbWlzZX1cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBmZXRjaDxUPih1cmw6IHN0cmluZywgcGFyYW1zID0ge30pOiBQcm9taXNlPFQ+IHtcclxuICAgIHJldHVybiByZXF1ZXN0PFQ+KCdHRVQnLCB7XHJcbiAgICAgICAgdXJsLFxyXG4gICAgICAgIHBhcmFtc1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlsIHoo4Vwb3N06K+35rGCXHJcbiAqIEBwYXJhbSB1cmxcclxuICogQHBhcmFtIGRhdGFcclxuICogQHJldHVybnMge1Byb21pc2V9XHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gcG9zdDxUPih1cmw6IHN0cmluZywgZGF0YSA9IHt9KTogUHJvbWlzZTxUPiB7XHJcbiAgICByZXR1cm4gcmVxdWVzdDxUPignUE9TVCcsIHtcclxuICAgICAgICB1cmwsXHJcbiAgICAgICAgZGF0YVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBkZWxldGVSZXF1ZXN0PFQ+KHVybDogc3RyaW5nKTogUHJvbWlzZTxUPiB7XHJcbiAgICByZXR1cm4gcmVxdWVzdDxUPignREVMRVRFJywge1xyXG4gICAgICAgIHVybCxcclxuICAgIH0pO1xyXG59XHJcblxyXG4vKipcclxuICog5bCB6KOFcHV06K+35rGCXHJcbiAqIEBwYXJhbSB1cmxcclxuICogQHBhcmFtIGRhdGFcclxuICogQHJldHVybnMge1Byb21pc2V9XHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gcHV0PFQ+KHVybDogc3RyaW5nLCBkYXRhID0ge30pIHtcclxuICAgIHJldHVybiByZXF1ZXN0PFQ+KCdQVVQnLCB7XHJcbiAgICAgICAgdXJsLFxyXG4gICAgICAgIGRhdGFcclxuICAgIH0pO1xyXG59Il19